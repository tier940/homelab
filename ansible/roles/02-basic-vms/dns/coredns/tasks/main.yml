---
- name: "[DNS] Download binary"
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
  with_items:
    - {
        url: "https://github.com/coredns/coredns/releases/download/v{{ genv.dns.coredns.version }}/coredns_{{ genv.dns.coredns.version }}_linux_amd64.tgz",
        dest: "/tmp/coredns_{{ genv.dns.coredns.version }}_linux_amd64.tgz",
      }
    - {
        url: "https://github.com/etcd-io/etcd/releases/download/v{{ genv.dns.etcd.version }}/etcd-v{{ genv.dns.etcd.version }}-linux-amd64.tar.gz",
        dest: "/tmp/etcd-v{{ genv.dns.etcd.version }}-linux-amd64.tar.gz",
      }

- name: "[DNS] Extract binary to /tmp"
  unarchive:
    src: "{{ item }}"
    dest: /tmp/
    remote_src: yes
  with_items:
    - "/tmp/coredns_{{ genv.dns.coredns.version }}_linux_amd64.tgz"
    - "/tmp/etcd-v{{ genv.dns.etcd.version }}-linux-amd64.tar.gz"

- name: "[DNS] Copy binary to /usr/local/bin"
  copy:
    src: "{{ item }}"
    dest: /usr/local/bin/
    remote_src: yes
  with_items:
    - "/tmp/coredns"
    - "/tmp/etcd-v{{ genv.dns.etcd.version }}-linux-amd64/etcd"
    - "/tmp/etcd-v{{ genv.dns.etcd.version }}-linux-amd64/etcdctl"

- name: "[DNS] Ensure binary is executable"
  file:
    path: "{{ item }}"
    mode: "0755"
    state: file
  with_items:
    - "/usr/local/bin/coredns"
    - "/usr/local/bin/etcd"
    - "/usr/local/bin/etcdctl"

- name: "[DNS] Create directory"
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - "/etc/coredns"
    - "/var/log/coredns"
    - "/var/log/etcd"
    - "/var/lib/etcd"

- name: "[DNS] Copy Corefile"
  template:
    src: "coredns/templates/Corefile.toml.j2"
    dest: /etc/coredns/Corefile
    owner: root
    group: root
    mode: 0644

- name: "[DNS] Copy coredns logrotate"
  copy:
    src: "coredns/files/logrotate.d/coredns"
    dest: /etc/logrotate.d/coredns
    owner: root
    group: root
    mode: 0644

- name: "[DNS] Copy etcd logrotate"
  copy:
    src: "coredns/files/logrotate.d/etcd"
    dest: /etc/logrotate.d/etcd
    owner: root
    group: root
    mode: 0644

- name: "[DNS] Copy coredns.service"
  copy:
    src: "coredns/files/systemd/coredns.service"
    dest: /usr/lib/systemd/system/coredns.service
    owner: root
    group: root
    mode: 0644

- name: "[DNS] Copy etcd.service"
  template:
    src: "coredns/templates/etcd.service.j2"
    dest: /usr/lib/systemd/system/etcd.service
    owner: root
    group: root
    mode: 0644

- name: "[DNS] Remove resolv.conf"
  file:
    path: /etc/resolv.conf
    state: absent

- name: "[DNS] Create static resolv.conf"
  copy:
    content: |
      nameserver 127.0.0.1
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: 0644

- name: "[DNS] Stop systemd-resolved service"
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
    daemon_reload: yes

- name: "[DNS] Start coredns service"
  systemd:
    name: coredns
    state: started
    enabled: yes
    daemon_reload: yes

- name: "[DNS] Start etcd service"
  systemd:
    name: etcd
    state: started
    enabled: yes
    daemon_reload: yes
