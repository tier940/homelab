---
- name: Add Kubernetes repository
  yum_repository:
    name: kubernetes
    description: Kubernetes
    baseurl: "https://pkgs.k8s.io/core:/stable:/v{{ genv.kubernetes.kube_version }}/rpm/"
    enabled: true
    gpgcheck: true
    gpgkey: "https://pkgs.k8s.io/core:/stable:/v{{ genv.kubernetes.kube_version }}/rpm/repodata/repomd.xml.key"

- name: Add CRI-O repository
  yum_repository:
    name: cri-o
    description: CRI-O
    baseurl: "https://download.opensuse.org/repositories/isv:/cri-o:/stable:/v{{ genv.kubernetes.crio_version }}/rpm/"
    enabled: true
    gpgcheck: true
    gpgkey: "https://download.opensuse.org/repositories/isv:/cri-o:/stable:/v{{ genv.kubernetes.crio_version }}/rpm/repodata/repomd.xml.key"

- name: Update repository cache
  dnf:
    update_cache: true

- name: Install packages
  dnf:
    name:
      - iproute-tc
      - iscsi-initiator-utils
      - container-selinux
      - cri-o
      - kubelet
      - kubeadm
      - kubectl
    state: present

- name: Exclude packages
  dnf:
    exclude:
      - cri-o
      - kubelet
      - kubeadm
      - kubectl

- name: Load kernel modules
  modprobe:
    name: "{{ item }}"
  with_items:
    - iscsi_tcp

- name: Ensure kernel modules are loaded at boot
  lineinfile:
    path: /etc/modules-load.d/common.conf
    create: true
    line: "{{ item }}"
    mode: u=rw,g=r,o=r
  with_items:
    - iscsi_tcp

- name: Check if CRI-O bridge network config is disabled
  stat:
    path: /etc/cni/net.d/10-crio-bridge.conflist.disabled
  register: crio_bridge_disabled

- name: Enable CRI-O bridge network
  when: crio_bridge_disabled.stat.exists
  command: mv /etc/cni/net.d/10-crio-bridge.conflist.disabled /etc/cni/net.d/10-crio-bridge.conflist
  args:
    creates: /etc/cni/net.d/10-crio-bridge.conflist

- name: Create CRI-O config drop-in directory
  file:
    path: /etc/crio/crio.conf.d
    state: directory
    mode: u=rwx,g=rx,o=rx
    owner: root
    group: root

- name: Copy CRI-O short name mode configuration
  copy:
    src: 01-shortname.conf
    dest: /etc/crio/crio.conf.d/01-shortname.conf
    mode: u=rw,g=r,o=r
    owner: root
    group: root
  register: crio_shortname_changed

- name: Copy registries.conf for CRI-O
  copy:
    src: registries.conf
    dest: /etc/containers/registries.conf
    mode: u=rw,g=r,o=r
    owner: root
    group: root
  register: registries_conf_changed

- name: Start open-iscsi service
  systemd:
    name: iscsid
    state: started
    enabled: true
    daemon_reload: true

- name: Start CRI-O service
  systemd:
    name: crio
    state: started
    enabled: true
    daemon_reload: true

- name: Restart CRI-O if configuration changed
  when: crio_shortname_changed.changed or registries_conf_changed.changed
  systemd:
    name: crio
    state: restarted

- name: Start kubelet service
  systemd:
    name: kubelet
    state: started
    enabled: true
    daemon_reload: true

- name: Wait for server to restart
  reboot:
    reboot_timeout: 3600
