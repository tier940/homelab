---
- name: Display current node information
  debug:
    msg: "Upgrading first control plane node: {{ inventory_hostname }}"

- name: Get current kubeadm version
  command: kubeadm version -o short
  register: current_kubeadm_version
  changed_when: false

- name: Display current kubeadm version
  debug:
    msg: "Current kubeadm version: {{ current_kubeadm_version.stdout }}"

- name: Update Kubernetes repository
  yum_repository:
    name: kubernetes
    description: Kubernetes
    baseurl: "https://pkgs.k8s.io/core:/stable:/v{{ genv.kubernetes.kube_version }}/rpm/"
    enabled: true
    gpgcheck: true
    gpgkey: "https://pkgs.k8s.io/core:/stable:/v{{ genv.kubernetes.kube_version }}/rpm/repodata/repomd.xml.key"

- name: Update CRI-O repository
  yum_repository:
    name: cri-o
    description: CRI-O
    baseurl: "https://download.opensuse.org/repositories/isv:/cri-o:/stable:/v{{ genv.kubernetes.crio_version }}/rpm/"
    enabled: true
    gpgcheck: true
    gpgkey: "https://download.opensuse.org/repositories/isv:/cri-o:/stable:/v{{ genv.kubernetes.crio_version }}/rpm/repodata/repomd.xml.key"

- name: Update repository cache
  dnf:
    update_cache: true

- name: Get node hostname
  command: hostname -s
  register: node_hostname_result
  changed_when: false

- name: Display node name
  debug:
    msg: "Using node name: {{ node_hostname_result.stdout }}"

- name: Drain control plane node
  delegate_to: localhost
  become: false
  command: kubectl drain {{ node_hostname_result.stdout }} --ignore-daemonsets --delete-emptydir-data
  register: drain_result

- name: Apply kubeadm upgrade
  command: kubeadm upgrade apply v{{ genv.kubernetes.kubeadm.kube_version }} --yes
  register: upgrade_apply

- name: Display upgrade result
  debug:
    msg: "{{ upgrade_apply.stdout_lines }}"

- name: Temporarily remove package exclusions for kubelet and kubectl
  dnf:
    exclude: []

- name: Upgrade CRI-O
  dnf:
    name: cri-o
    state: latest
    disable_excludes: kubernetes

- name: Upgrade kubelet and kubectl
  dnf:
    name:
      - kubelet
      - kubectl
    state: latest
    disable_excludes: kubernetes

- name: Re-apply package exclusions
  dnf:
    exclude:
      - cri-o
      - kubelet
      - kubeadm
      - kubectl

- name: Restart CRI-O
  systemd:
    name: crio
    state: restarted
    daemon_reload: true

- name: Restart kubelet
  systemd:
    name: kubelet
    state: restarted
    daemon_reload: true

- name: Wait for kubelet to be ready
  wait_for:
    timeout: 60

- name: Uncordon control plane node
  delegate_to: localhost
  become: false
  command: kubectl uncordon {{ node_hostname_result.stdout }}

- name: Wait for node to be ready
  delegate_to: localhost
  become: false
  command: kubectl wait --for=condition=Ready node/{{ node_hostname_result.stdout }} --timeout=300s
  changed_when: false

- name: Verify node status
  delegate_to: localhost
  become: false
  command: kubectl get nodes
  register: nodes_status
  changed_when: false

- name: Display nodes status
  debug:
    msg: "{{ nodes_status.stdout_lines }}"
