---
- name: Display current node information
  debug:
    msg: "Upgrading first control plane node: {{ inventory_hostname }}"

- name: Get current kubeadm version
  command: kubeadm version -o short
  register: current_kubeadm_version

- name: Display current kubeadm version
  debug:
    msg: "Current kubeadm version: {{ current_kubeadm_version.stdout }}"

# Update repositories using common task
- name: Update Kubernetes and CRI-O repositories
  include_tasks: ../common/tasks/update-repositories.yml

- name: Get node hostname
  command: hostname -s
  register: node_hostname_result

- name: Display node name
  debug:
    msg: "Using node name: {{ node_hostname_result.stdout }}"

- name: Drain control plane node
  delegate_to: localhost
  become: false
  command: kubectl drain {{ node_hostname_result.stdout }} --ignore-daemonsets --delete-emptydir-data
  register: drain_result

- name: Apply kubeadm upgrade
  command: kubeadm upgrade apply v{{ genv.kubernetes.kubeadm.kube_version }} --yes
  register: upgrade_apply

- name: Display upgrade result
  debug:
    msg: "{{ upgrade_apply.stdout_lines }}"

- name: Temporarily remove package exclusions for kubelet and kubectl
  dnf:
    exclude: []

- name: Upgrade CRI-O
  dnf:
    name: cri-o
    state: latest  # noqa: package-latest
    disable_excludes: kubernetes
  notify: Restart CRI-O

- name: Upgrade kubelet and kubectl
  dnf:
    name:
      - kubelet
      - kubectl
    state: latest  # noqa: package-latest
    disable_excludes: kubernetes
  notify: Restart kubelet

- name: Re-apply package exclusions
  dnf:
    exclude:
      - cri-o
      - kubelet
      - kubeadm
      - kubectl

- name: Flush handlers to restart services
  meta: flush_handlers

- name: Wait for kubelet to be ready
  wait_for:
    timeout: 60

- name: Uncordon control plane node
  delegate_to: localhost
  become: false
  command: kubectl uncordon {{ node_hostname_result.stdout }}

- name: Wait for node to be ready
  delegate_to: localhost
  become: false
  command: kubectl wait --for=condition=Ready node/{{ node_hostname_result.stdout }} --timeout=300s

- name: Verify node status
  delegate_to: localhost
  become: false
  command: kubectl get nodes
  register: nodes_status

- name: Display nodes status
  debug:
    msg: "{{ nodes_status.stdout_lines }}"
