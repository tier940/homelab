# kube-prometheus-stack Development Environment Configuration

# Prometheus
prometheus:
  enabled: true
  prometheusSpec:
    replicas: 3
    retention: 7d
    retentionSize: "8GiB"

    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi

    # Thanos sidecar for MinIO/S3 object storage
    thanos:
      objectStorageConfig:
        existingSecret:
          name: thanos-objstore-config
          key: objstore.yml

    # ServiceMonitor auto-discovery
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

# Grafana
grafana:
  enabled: true
  replicas: 3
  adminUser: "admin"
  admin:
    ## Name of the secret. Can be templated.
    existingSecret: "grafana-admin-credentials"
    userKey: admin-user
    passwordKey: admin-password

  # Persistence configuration for RWX storage
  persistence:
    enabled: true
    type: pvc
    storageClassName: longhorn-rwx
    accessModes:
      - ReadWriteMany
    size: 5Gi

  # Timezone and locale settings
  grafana.ini:
    server:
      root_url: "https://grafana.k8s.tier.f5.si"
    date_formats:
      default_timezone: "Asia/Tokyo"
    plugin:
      grafana-image-renderer:
        rendering_timezone: "Asia/Tokyo"

  # Install plugins for S3/MinIO log access
  plugins:
    - yesoreyeram-infinity-datasource

  additionalDataSources:
    - name: "SelfHost Prometheus"
      type: prometheus
      uid: self_prometheus
      url: http://10.0.0.18:9090
      isDefault: false
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    - name: "K8S Prometheus"
      type: prometheus
      uid: k8s_prometheus
      access: proxy
      url: http://kube-prometheus-stack-prometheus.kube-prometheus-stack.svc:9090
      isDefault: true
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    - name: "K8S Loki"
      type: loki
      uid: k8s_loki
      access: proxy
      url: http://loki.kube-prometheus-stack.svc.cluster.local:3100
      jsonData:
        maxLines: 1000
        timeout: 60
      editable: true

  # Dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: "default"
          orgId: 1
          folder: ""
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default

  dashboards:
    default:
      selfhost-coredns:
        gnetId: 14981
        revision: 2
        datasource: "SelfHost Prometheus"
      k8s-traefik:
        gnetId: 17347
        revision: 9
        datasource: "K8S Prometheus"
      k8s-longhorn:
        gnetId: 16888
        revision: 11
        datasource: "K8S Prometheus"
      k8s-minio:
        gnetId: 13502
        revision: 26
        datasource:
          - name: DS_PROMETHEUS
            value: K8S Prometheus
      # k8s-hashicorp-vault:
      #   gnetId: 12904
      #   revision: 2
      #   datasource: "K8S Prometheus"

  # Ingress
  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - grafana.k8s.tier.f5.si
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure

# AlertManager
alertmanager:
  enabled: false
  alertmanagerSpec:
    replicas: 3
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi
