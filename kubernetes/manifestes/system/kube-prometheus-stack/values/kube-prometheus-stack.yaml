# kube-prometheus-stack Development Environment Configuration

# Prometheus
prometheus:
  enabled: true
  prometheusSpec:
    replicas: 1
    retention: 7d
    retentionSize: "15GB"

    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: local-path
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi

    # Thanos sidecar for MinIO/S3 object storage
    thanos:
      objectStorageConfig:
        existingSecret:
          name: thanos-objstore-config
          key: objstore.yml

    # ServiceMonitor auto-discovery
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

    # Resources for development
    resources:
      requests:
        cpu: 200m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi

# Grafana
grafana:
  enabled: true
  replicas: 1
  adminUser: "admin"
  admin:
    ## Name of the secret. Can be templated.
    existingSecret: "grafana-admin-credentials"
    userKey: admin-user
    passwordKey: admin-password

  # Persistence configuration for dashboards and data
  persistence:
    enabled: true
    type: pvc
    storageClassName: local-path
    accessModes:
      - ReadWriteOnce
    size: 10Gi

  # Disable init chown container to avoid permission issues with existing PVC
  initChownData:
    enabled: false

  # Timezone and locale settings
  grafana.ini:
    server:
      root_url: "https://grafana.k8s.tier.f5.si"
    users:
      default_theme: dark
      default_timezone: Asia/Tokyo
    date_formats:
      default_timezone: Asia/Tokyo

  # Install plugins for S3/MinIO log access
  plugins:
    - yesoreyeram-infinity-datasource

  # Data sources - disable default and configure manually
  sidecar:
    datasources:
      enabled: true
      defaultDatasourceEnabled: false

  additionalDataSources:
    - name: "SelfHost Prometheus"
      type: prometheus
      uid: self_prometheus
      url: http://10.0.0.18:9090
      isDefault: false
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    - name: "K8S Prometheus"
      type: prometheus
      uid: k8s_prometheus
      access: proxy
      url: http://kube-prometheus-stack-prometheus.kube-prometheus-stack.svc:9090
      isDefault: true
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    - name: "K8S Loki"
      type: loki
      uid: k8s_loki
      access: proxy
      url: http://loki.kube-prometheus-stack.svc.cluster.local:3100

  # Dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: "default"
          orgId: 1
          folder: ""
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default

  dashboards:
    default:
      selfhost-coredns:
        gnetId: 14981
        revision: 2
        datasource: "SelfHost Prometheus"
      k8s-traefik:
        gnetId: 17347
        revision: 9
        datasource: "K8S Prometheus"
      k8s-traefik-log:
        gnetId: 17501
        revision: 1
        datasource: "K8S Loki"
      k8s-minio:
        gnetId: 13502
        revision: 26
        datasource:
          - name: DS_PROMETHEUS
            value: K8S Prometheus
      k8s-hashicorp-vault:
        gnetId: 12904
        revision: 2
        datasource: "K8S Prometheus"

  # Ingress
  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - grafana.k8s.tier.f5.si
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
      traefik.ingress.kubernetes.io/router.middlewares: traefik-redirect-https@kubernetescrd

  # Resources - increased for Loki queries
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 2000m
      memory: 2Gi

# AlertManager
alertmanager:
  enabled: true
  alertmanagerSpec:
    replicas: 1
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: local-path
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi

# node-exporter
nodeExporter:
  enabled: true

# kube-state-metrics
kubeStateMetrics:
  enabled: true

# kubelet
kubelet:
  enabled: true
  serviceMonitor:
    interval: 30s

# Prometheus Operator
prometheusOperator:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
