---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: image-cleanup
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: image-cleanup
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: image-cleanup
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: image-cleanup
subjects:
  - kind: ServiceAccount
    name: image-cleanup
    namespace: kube-system
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: image-cleanup
  namespace: kube-system
spec:
  # Run daily at 2:00 AM
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 300
      template:
        spec:
          serviceAccountName: image-cleanup
          hostNetwork: true
          hostPID: true
          restartPolicy: OnFailure
          tolerations:
            - effect: NoSchedule
              operator: Exists
          nodeSelector:
            kubernetes.io/os: linux
          containers:
            - name: image-cleanup
              image: alpine:3.19
              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  echo "Starting container image cleanup..."

                  # Install crictl if not available
                  if ! command -v crictl &> /dev/null; then
                    echo "Installing crictl..."
                    apk add --no-cache curl
                    CRICTL_VERSION="v1.31.1"
                    curl -L "https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-amd64.tar.gz" | tar -C /usr/local/bin -xz
                  fi

                  # Configure crictl for CRI-O
                  cat > /etc/crictl.yaml <<EOF
                  runtime-endpoint: unix:///var/run/crio/crio.sock
                  image-endpoint: unix:///var/run/crio/crio.sock
                  timeout: 10
                  debug: false
                  EOF

                  echo "Container runtime information:"
                  crictl version || true
                  crictl info || true

                  # Get list of images currently in use
                  echo "Getting list of images in use..."
                  IMAGES_IN_USE=$(crictl images -q)

                  # Get all images
                  echo "Getting list of all images..."
                  ALL_IMAGES=$(crictl images -q)

                  # Show current disk usage
                  echo "Current images:"
                  crictl images

                  # Remove unused images
                  echo "Removing unused images..."
                  crictl rmi --prune || echo "Failed to prune images, but continuing..."

                  echo "Images after cleanup:"
                  crictl images

                  echo "Image cleanup completed successfully"
              securityContext:
                privileged: true
              volumeMounts:
                - name: crio-sock
                  mountPath: /var/run/crio/crio.sock
                  readOnly: false
                - name: containers-storage
                  mountPath: /var/lib/containers
                  readOnly: false
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          volumes:
            - name: crio-sock
              hostPath:
                path: /var/run/crio/crio.sock
                type: Socket
            - name: containers-storage
              hostPath:
                path: /var/lib/containers
                type: Directory
